<script lang="ts" setup>
import { nextTick, ref, onMounted, defineProps } from 'vue'
import QReply from '@/pages/user/components/Qreply.vue'
import { ElMessageBox } from 'element-plus'
import { selectQComment } from '@/api/user/qcomment'
import { warnMsg } from '@/composables/utils'
import EventBus from '@/eventBus'
import _ from 'lodash'
import { supportQCommentReply } from '@/api/user/qcomment'

const props = defineProps({
  id: Number,
  index: Number,
  //父ID
  parentIndex: {
    type: Number,
    default: -1
  },
  size: {
    type: Number,
    default: 40
  },
  text: {
    type: String,
    default: '',
    require: true
  },
  time: String,
  isShowDivider: {
    type: Boolean,
    default: true
  },
  isCommentContainer: {
    type: Boolean,
    default: false
  },
  nickName: String,
  replyName: {
    trpe: String,
    default: null
  },
  arvatarUrl: String,
  supportNum: {
    type: Number,
    default: 0
  },
  replyNum: {
    type: Number,
    default: 0
  },
  isSelf: Boolean,
  isShowReplyDialog: Boolean,
  replyOuterCommentId: Number,
  replyInnerCommentId: Number,
  askId: Number,
  isSelected: Number,
  isAuthor: {
    type: Boolean,
    default: false
  },
  questionIndex: Number
})

//控制是否显示展开按钮，默认不出现
const isShowAll = ref(false)
//文本div元素
const description = ref()

nextTick(() => {
  //动态计算文本行数来确定是否展示
  const des = window.getComputedStyle(description.value)
  const height: number = Number(des.height.substring(0, des.height.length - 2))
  const lineHeight: number = Number(
    des.lineHeight.substring(0, des.lineHeight.length - 2)
  )
  const lines = Math.round(height / lineHeight)
  if (lines > 3) {
    description.value.classList.add('line-clamp-3')
    isShowAll.value = true
  }
})

//控制文本展开函数
const showAll = (e: Event) => {
  if (e.target != null) {
    if (e.target.innerText === '展开') {
      e.target.innerText = '收起'
    } else {
      e.target.innerText = '展开'
    }
  }
  description.value.classList.toggle('line-clamp-3')
}

onMounted(() => {})

//自定义事件，父组件修改已经打开的对话框，设置为隐藏,当前对话框显示
const emits = defineEmits([
  'handleReplyDialog',
  'showIsSelectedIcon',
  'toggleSupport'
])
const toggleReply = (parentIndex: Number, index: Number) => {
  emits('handleReplyDialog', { parentIndex, index })
}
//采纳某个问答回复
const selectQCommentReply = () => {
  selectQComment(props.askId, props.id).then((res) => {
    if (res.success) {
      emits('showIsSelectedIcon', {
        parentIndex: props.parentIndex,
        index: props.index
      })
      ElMessageBox.confirm(
        '采纳成功！当前问答回复对你是否有帮助呢?',
        '是否结题',
        {
          confirmButtonText: '结题',
          cancelButtonText: '取消',
          type: 'warning'
        }
      ).then(() => {
        EventBus.emit('overCurQuestion', {
          askId: props.askId,
          questionIndex: props.questionIndex
        })
      })
    } else {
      warnMsg(res.message)
    }
  })
}
//点赞某个评论
const support = _.debounce(
  () => {
    supportQCommentReply(props.id).then((res) => {
      if (res.success) {
        emits('toggleSupport', {
          parentIndex: props.parentIndex,
          index: props.index
        })
      }
    })
  },
  800,
  { leading: 'true', trailing: false }
)
</script>

<template>
  <!-- 评论区item部分 -->
  <div class="flex flex-col p-7" v-bind:data-comment-id="props.articleId">
    <div class="flex justify-between items-center">
      <div class="flex justify-center items-center gap-1">
        <el-avatar :size="size" :src="props.arvatarUrl" />
        <div class="flex-col justify-center items-center">
          <div class="flex items-center">
            <p class="ml-2 line-clamp-1 cursor-default text-sm">
              {{ nickName
              }}<span v-if="replyName != null" class="text-[#4E6EF2]">{{
                '@' + replyName
              }}</span>
            </p>
            <el-tag
              v-if="props.isSelf"
              class="ml-3"
              effect="plain"
              type="warning"
              round
              >题主</el-tag
            >
          </div>
          <span class="text-xs">{{ time }}</span>
        </div>
      </div>
      <!-- 是否采纳 -->
      <div v-if="isSelected === 1 ? true : false">
        <svg
          t="1713199412403"
          class="icon"
          viewBox="0 0 1422 1024"
          version="1.1"
          xmlns="http://www.w3.org/2000/svg"
          p-id="51270"
          width="50"
          height="50"
        >
          <path
            d="M711.110716 853.333428c41.898643 0 82.062177-7.566218 119.153712-21.361766l-42.83731-16.469324c-24.433764 6.143997-49.976861 9.386661-76.316402 9.386662a312.604271 312.604271 0 0 1-259.697633-138.353701l-42.922643-16.497769A341.304699 341.304699 0 0 0 711.110716 853.333428z m0-682.666287c-41.927088 0-82.062177 7.566218-119.182156 21.39021l42.808865 16.44088C659.199634 202.354234 684.771175 199.111569 711.110716 199.111569a312.604271 312.604271 0 0 1 259.726078 138.382146l42.894198 16.440879A341.304699 341.304699 0 0 0 711.110716 170.667141z"
            fill="#83C474"
            p-id="51271"
          ></path>
          <path
            d="M711.110716 1024c122.111932 0 234.211425-42.751976 322.218488-114.062159l-30.975983-11.889771A481.421955 481.421955 0 0 1 711.110716 995.555571c-235.605202 0-431.87176-168.504795-474.822847-391.594449l-30.947539-11.889771C243.768753 836.807215 455.565969 1024 711.110716 1024z m0-1023.999431a509.866383 509.866383 0 0 0-322.218488 114.062159l30.947539 11.918215A481.421955 481.421955 0 0 1 711.110716 28.444998c235.605202 0 431.87176 168.504795 474.822847 391.594449l30.947539 11.889771C1178.452679 187.193354 966.655463 0.000569 711.110716 0.000569z"
            fill="#83C474"
            p-id="51272"
          ></path>
          <path
            d="M752.668026 144.868044c-0.512 3.583998 1.507555 5.091553 4.551109 3.384887l22.471099-12.600882 22.926209 12.20266c3.128887 1.649777 5.119997 0.085333 4.437331-3.47022l-4.807109-26.225764 18.033768-18.773322c2.446221-2.559999 1.621332-5.006219-1.820443-5.51822l-25.429319-3.612442-11.775994-23.807987c-1.592888-3.21422-4.095998-3.185776-5.575108 0.056889l-10.922661 24.007098-25.315541 4.067553c-3.413331 0.568889-4.124442 3.015109-1.592888 5.518219l18.68799 18.488879-3.868443 26.282652zM920.035044 208.896453c-1.934221 3.071998-0.682666 5.262219 2.787554 4.94933l25.656875-2.389332 15.957325 20.479989c2.190221 2.75911 4.636442 2.161777 5.489774-1.336888l6.257775-25.941319 24.120875-9.813328c3.271109-1.336888 3.527109-3.925331 0.568889-5.774219l-21.759988-13.653326-1.080889-26.538652c-0.142222-3.583998-2.446221-4.579553-5.119997-2.218665l-19.740433 17.493324-24.746653-6.570663c-3.356443-0.881777-5.034664 1.080888-3.754665 4.380442l9.585773 24.462208-14.222215 22.471099zM315.647825 720.896168c-1.934221 3.071998-0.682666 5.262219 2.815998 4.949331l25.656875-2.389332 15.92888 20.479989c2.190221 2.75911 4.636442 2.161777 5.489774-1.336889l6.257775-25.941318 24.120875-9.813328c3.271109-1.336888 3.527109-3.925331 0.568889-5.774219l-21.759988-13.653326-1.052444-26.538652c-0.170667-3.583998-2.446221-4.579553-5.119997-2.218665l-19.740434 17.493323-24.746652-6.570663c-3.384887-0.881777-5.034664 1.080888-3.754665 4.380442l9.557328 24.462209-14.222214 22.471098zM837.34709 914.261394c-1.592888 3.21422-0.142222 5.290664 3.299554 4.607998l25.258653-5.034664 18.033767 18.687989c2.446221 2.531554 4.807108 1.678221 5.290664-1.905776l3.527109-26.453319 22.954654-12.287993c3.128887-1.678221 3.100443-4.266664-0.028444-5.802663l-23.068432-11.292439-3.839998-26.282652c-0.540444-3.555554-2.929776-4.323553-5.319108-1.678221l-17.806212 19.484434-25.315542-3.98222c-3.441776-0.512-4.892442 1.592888-3.271109 4.778664l12.088882 23.324431-11.804438 23.836431zM1023.743431 313.742617c-3.242665 1.535999-3.356443 4.095998-0.227555 5.660441l23.039987 11.576883 2.673776 25.827541c0.369778 3.498665 2.75911 4.266664 5.347553 1.763554l19.057767-18.687989 25.656875 4.437331c3.47022 0.625777 5.063108-1.422221 3.527109-4.551109l-11.207105-23.12532 13.141326-23.068432c1.791999-3.128887 0.369778-5.176886-3.157332-4.579553l-25.998207 4.351997-17.521768-18.687989c-2.389332-2.559999-4.835553-1.763555-5.489775 1.73511l-4.835553 25.827541-24.007098 11.519994zM640.369422 925.297833c-2.673776 2.417776-2.076443 4.863997 1.336888 5.518219l25.315542 4.807108 9.69955 24.063987c1.336888 3.271109 3.839998 3.356443 5.631997 0.227555l13.198215-23.210654 25.88443-2.787554c3.498665-0.398222 4.465775-2.787554 2.133332-5.404441l-17.180435-19.086212 6.286219-25.827541c0.853333-3.498665-1.080888-5.091553-4.295109-3.527109l-23.807987 11.377772-21.987543-13.169771c-2.986665-1.763555-5.119997-0.341333-4.778664 3.214221l2.446221 26.140429-19.882656 17.692435zM556.373024 171.520474c0.341333 3.555554 2.673776 4.551109 5.205331 2.133332l18.773323-17.66399 25.173319 6.286218c3.413331 0.853333 4.977775-1.137777 3.498665-4.408886l-11.036439-24.291542 12.942215-22.584877c1.763555-3.071998 0.369778-5.262219-3.071998-4.892441l-25.571541 2.645332-17.180435-20.280878c-2.332443-2.730665-4.75022-2.104888-5.404442 1.422221l-4.778664 25.941319-23.551987 10.040884c-3.185776 1.393777-3.299554 3.953776-0.255999 5.774219l22.61332 13.368881 2.616888 26.481763zM477.41129 888.320075c0 3.640887 2.275554 4.807108 5.00622 2.645332l20.223989-15.985769 24.547541 8.47644c3.327998 1.137777 5.063108-0.682666 3.868443-4.095998l-8.874662-25.173319 14.876436-21.361766c1.99111-2.901332 0.824888-5.20533-2.673776-5.148441l-25.685319 0.398222-15.359992-21.674655c-2.076443-2.929776-4.551109-2.50311-5.489774 0.938666l-7.025774 25.429319-24.348431 7.96444c-3.299554 1.080888-3.612442 3.640887-0.739555 5.688886l21.333321 15.331547 0.341333 26.595541zM235.007869 85.504521a56.888857 56.888857 0 0 0-73.500403 32.711093l-122.311043 318.662934a56.888857 56.888857 0 0 0 32.711093 73.500404l1115.306047 428.117096a56.888857 56.888857 0 0 0 73.500403-32.711093l122.311043-318.662935a56.888857 56.888857 0 0 0-32.711093-73.500403L235.007869 85.504521z m-10.211549 26.538652l1115.306047 428.14554a28.444429 28.444429 0 0 1 17.379546 33.564426l-0.995555 3.185776-122.311044 318.662934a28.444429 28.444429 0 0 1-33.59287 17.351102l-3.157331-0.995555-1115.306048-428.14554a28.444429 28.444429 0 0 1-17.379545-33.564426l0.995555-3.185776 122.311043-318.662934a28.444429 28.444429 0 0 1 33.59287-17.351102l3.157332 0.995555z"
            fill="#83C474"
            p-id="51273"
          ></path>
          <path
            d="M443.277976 555.26426c12.999104 4.266664 24.974208 4.465775 35.299536 0.398222 9.102217-4.551109 23.665765-26.367985 43.463087-65.564408l-28.586651-22.698654c-14.392881 31.772427-24.462209 49.493306-30.63465 52.223971a23.210654 23.210654 0 0 1-16.554657 0.227556l-158.378579-60.785744c-11.463105-4.408886-14.990214-12.344882-10.609772-23.807987l32.682649-85.077286 196.607891 75.463069 52.337748-136.391035-243.114531-93.326171-12.231105 31.85776 209.350995 80.383956-27.87554 72.647071-162.844354-62.520855 16.127991-42.040865-33.137759-12.743104-63.345743 165.063019c-11.007994 28.700428-3.128887 48.156418 24.263098 58.680857l177.180346 68.010628z m191.943004-199.054111c101.347499 38.883534 185.372341 63.829298 251.647861 75.007958l-5.631997-33.962648c-69.233739-14.876436-150.983027-40.021311-244.650531-76.003513l-1.365333 34.958203z m163.32791 155.56258a318.918934 318.918934 0 0 0 75.576847-52.167082l-24.632876-26.282652c-22.67021 20.935099-46.193752 37.489757-70.513738 49.351084l19.569767 29.09865z m-73.471959-45.767086l35.356424 4.067554a377.941123 377.941123 0 0 0-3.98222-65.877297l-34.929758-1.336888c3.271109 20.991988 4.380442 41.898643 3.555554 63.146631z m-85.219509-18.062212l35.83998-1.99111a381.809566 381.809566 0 0 0-8.959995-67.043518l-35.896869-1.706666c4.977775 21.276433 8.021329 44.743086 9.016884 70.741294z m36.437313 207.018552l44.287976-115.370603c6.655996 46.449752 28.814206 94.435503 65.905741 144.497698l35.527091-21.077322c-38.08709-39.850645-62.634632-77.795512-73.67107-113.834603l85.077286 32.654204 12.487104-32.511982-112.497715-43.178643 9.927106-25.799097-33.13776-12.743104-9.927105 25.827542-112.156382-43.064865-12.487105 32.511982 84.764398 32.540426c-33.678204 21.048877-76.999068 32.967093-129.962595 35.669313l7.139552 38.570646c60.2453-8.334218 110.079939-28.671984 149.247917-61.155522l-43.662198 113.74927 33.137759 12.71466z m300.401611 117.503935l38.399979-100.0675 10.808883 31.943093c23.12532-12.686215 43.80442-30.350205 61.866632-52.679082 0.881777 26.311096 0.967111 50.830194-0.028444 73.471959l33.08087-8.135106-20.309322 52.906637c-3.157332 8.277329-7.96444 11.207105-14.307547 8.760884l-25.543097-11.633771-3.896887 33.991092 28.359095 10.865772c20.394655 7.850662 35.128869-0.028444 43.946643-22.983099l80.839066-210.630994-66.901296-25.685319c6.48533-15.075547 13.055993-31.175094 19.6551-48.383973l-31.85776-12.231104a1235.227758 1235.227758 0 0 1-19.996434 48.241751l-70.428405-27.022208-94.919058 247.295863 31.231982 11.975105z m-107.121718-126.663041c30.577761 6.968885 64.796408 10.239994 102.200832 9.95555l10.751994-28.017762a526.620152 526.620152 0 0 1-59.875522-3.98222c25.941319-17.095102 60.899522-45.368864 104.846164-85.532397l-25.543097-22.983099c-10.638216 10.552883-21.048877 20.479989-30.833761 29.86665-9.415106-2.161777-19.1431-4.437331-28.757317-7.025773 22.954654-17.863101 48.270195-42.894198 75.832847-74.723515l-26.254208-23.978653a690.744505 690.744505 0 0 1-69.68885 79.6444c-6.343108 4.152887-12.401771 6.570663-18.346657 6.855108l-3.413331 32.711093c15.502214 3.384887 30.719983 6.655996 44.942197 9.557328-23.722653 20.878211-42.040866 34.303981-54.897747 41.102199-5.404441 2.673776-11.719105 3.896887-18.43199 4.23822l-2.559998 32.312871z m146.88703 23.096876l42.951087-111.843494 37.262201 14.307548c-4.863997 9.841772-9.614217 19.342211-14.307547 27.761762-17.777768 30.12265-39.907533 53.447081-65.905741 69.774184z m104.732386 47.160863a916.593269 916.593269 0 0 0-8.703995-102.05861c5.063108-9.386661 10.382216-19.427545 16.042657-30.407095l37.916424 14.563548-45.226642 117.902157z m-280.2914-8.874662c39.765311 6.826663 76.885291 10.126217 110.620383 9.927105l11.975104-31.231982c-34.36087-0.028444-72.618626-4.124442-114.830158-12.287993l-7.765329 33.564425z"
            fill="#83C474"
            p-id="51274"
          ></path>
        </svg>
      </div>
    </div>
    <!-- 评论内容盒子 -->
    <div ref="description" class="my-2 cursor-pointer text-base">
      {{ text }}
    </div>
    <!-- 是否显示展开文本数据 -->
    <div
      @click="showAll"
      v-if="isShowAll"
      class="cursor-pointer text-sm text-[#4B7AE3]"
    >
      展开
    </div>
    <!-- 底部的评论区域 -->
    <div class="flex flex-1 justify-between items-center">
      <div class="flex items-center p-1">
        <div class="flex gap-3">
          <!-- 点赞人数 -->
          <div
            class="flex gap-1 justify-center items-center hover:text-[#1A56DB]"
          >
            <svg
              @click.stop="support"
              t="1709147170474"
              class="w-[16px] h-[16px] cursor-pointer"
              viewBox="0 0 1024 1024"
              version="1.1"
              xmlns="http://www.w3.org/2000/svg"
              p-id="41022"
            >
              <path
                d="M259.60156269 433.88281277h-93.75000019a10.82812473 10.82812473 0 0 0-10.82812473 10.85156186v390.2812501c0 5.97656223 4.8515625 10.82812473 10.82812473 10.82812554h93.75000018V433.88281277z m64.9218749-3.3281249v415.2890624h447.09374982a10.82812473 10.82812473 0 0 0 10.80468759-10.82812554V830.74999963l86.484375-324.93749936a97.57031232 97.57031232 0 0 0-97.28906259-93.6093749h-181.12500028l7.54687574-38.71875064c5.15625018-26.62500009 11.32031277-45.28125027 11.32031195-81.56249946V247.53125009c0-53.7890625-43.6640625-71.78906223-97.35937482-71.78906222-53.67187518 0-97.35937481 17.99999973-97.35937481 71.78906222v44.43750028c0 50.85937463-28.42968741 82.03125037-84.49218732 133.42968732l-5.62500028 5.15625018z m447.09374982 480.32812463H165.82812537A75.89062491 75.89062491 0 0 1 90.125 835.01562473V444.73437463a75.89062491 75.89062491 0 0 1 75.70312537-75.8906249h129.515625c26.60156213-26.13281287 54.39843787-41.29687491 54.39843704-76.89843732V247.50781213C349.74218741 157.85937463 422.51562491 110.67968769 512 110.67968769s162.25781259 47.15624981 162.25781259 136.82812444v44.43750028c0 25.71093787-2.62500019 31.68750009-5.97656222 55.21874991h103.33593704c89.48437509 0 162.25781259 72.93749991 162.25781259 162.60937536v4.26562509l-86.6953125 325.78124936a75.91406287 75.91406287 0 0 1-75.56250009 71.06250037z"
                fill="currentColor"
                p-id="41023"
              ></path>
            </svg>
            <span class="text-xs cursor-default select-none">{{
              supportNum
            }}</span>
          </div>
          <!-- 评论回复按钮 -->
          <div
            @click="toggleReply(props.parentIndex, props.index)"
            class="flex gap-1 justify-center items-center hover:text-[#1A56DB]"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-[16px] h-[16px] cursor-pointer"
              viewBox="0 0 1024 1024"
            >
              <path
                fill="currentColor"
                d="m174.72 855.68 135.296-45.12 23.68 11.84C388.096 849.536 448.576 864 512 864c211.84 0 384-166.784 384-352S723.84 160 512 160 128 326.784 128 512c0 69.12 24.96 139.264 70.848 199.232l22.08 28.8-46.272 115.584zm-45.248 82.56A32 32 0 0 1 89.6 896l58.368-145.92C94.72 680.32 64 596.864 64 512 64 299.904 256 96 512 96s448 203.904 448 416-192 416-448 416a461.056 461.056 0 0 1-206.912-48.384l-175.616 58.56z"
              ></path>
              <path
                fill="currentColor"
                d="M512 563.2a51.2 51.2 0 1 1 0-102.4 51.2 51.2 0 0 1 0 102.4m192 0a51.2 51.2 0 1 1 0-102.4 51.2 51.2 0 0 1 0 102.4m-384 0a51.2 51.2 0 1 1 0-102.4 51.2 51.2 0 0 1 0 102.4"
              ></path>
            </svg>
            <span class="text-xs cursor-default select-none">{{
              replyNum === 0 ? '回复' : replyNum
            }}</span>
          </div>
        </div>
      </div>
      <!-- 题主是否采纳当前答复? -->
      <div v-if="isAuthor && isSelected !== 1" class="text-xs select-none">
        <el-popconfirm
          confirm-button-text="采纳"
          cancel-button-text="取消"
          confirm-button-type="success"
          cancel-button-type="danger"
          icon-color="#1a56db"
          title="是否采纳当前答复?"
          @confirm="selectQCommentReply"
        >
          <template #reference>
            <el-icon class="cursor-pointer"><MoreFilled /></el-icon>
          </template>
        </el-popconfirm>
      </div>
    </div>
    <!-- 点击评论展开回复文本框 -->
    <QReply
      v-if="props.isShowReplyDialog"
      @closeReplyDialog="toggleReply(props.parentIndex, props.index)"
      :replyName="nickName"
      :replyOuterCommentId="replyOuterCommentId"
      :replyInnerCommentId="replyInnerCommentId"
      :askId="askId"
      :isChild="true"
      :questionIndex="questionIndex"
    ></QReply>
    <!-- 回复部分，继续循环自身 -->
    <div>
      <slot></slot>
    </div>
  </div>
  <el-divider v-if="isShowDivider" />
</template>

<style scoped>
/* 修改默认外边距 */
.el-divider--horizontal {
  margin: 10px 0 !important;
}
.el-drawer__header {
  margin-bottom: 0 !important;
}
:global(.el-popconfirm__main) {
  font-size: 13px;
}
</style>
